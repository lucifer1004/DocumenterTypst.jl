# Comprehensive CI workflow for DocumenterTypst.jl
#
# Features:
# - Multi-platform testing (Linux, macOS, Windows)
# - Typst backend specific tests
# - Code coverage (Codecov + Coveralls)
# - Documentation building
# - Code formatting (Runic)
# - Spell checking (Typos)
# - Link checking
# - Prettier formatting
# - Changelog enforcement

name: CI

on:
  push:
    branches:
      - main
      - 'release-*'
    tags: '*'
  pull_request:
  workflow_dispatch:

concurrency:
  # Improved concurrency control following Documenter.jl pattern
  # group by workflow and ref; for PRs limit to 1 concurrent job
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.ref != 'refs/heads/main' || github.run_number }}
  # Cancel intermediate builds, but only if it is a pull request build
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================

  changelog:
    name: Changelog Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: dangoslen/changelog-enforcer@v3
        with:
          changeLogPath: 'CHANGELOG.md'
          skipLabels: 'Skip Changelog,dependencies'

  runic:
    name: "Runic (Julia code formatting)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'
      - uses: julia-actions/cache@v2
      - uses: fredrikekre/runic-action@v1
        with:
          version: '1.5'

  prettier:
    name: Prettier (formatting)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actionsx/prettier@v3
        with:
          args: --check .

  typos:
    name: Spell Check with Typos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: crate-ci/typos@master

  # ============================================================================
  # Main Test Suite
  # ============================================================================

  test:
    name: Julia ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.6'  # Minimum supported version
          - '1'     # Latest stable
          - 'nightly'
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        arch:
          - default
        include:
          - os: ubuntu-latest
            version: '1'
            arch: x86
        exclude:
          - os: macos-latest
            version: '1.6'
            arch: default
    continue-on-error: ${{ matrix.allow_failure || false }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
          show-versioninfo: true

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Build package
        uses: julia-actions/julia-buildpkg@v1

      - name: Run tests
        uses: julia-actions/julia-runtest@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process coverage
        uses: julia-actions/julia-processcoverage@v1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info

      - name: Submit coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: lcov.info
          flag-name: test-${{ join(matrix.*, '-') }}
          parallel: true

  # ============================================================================
  # Typst Backend Specific Tests
  # ============================================================================

  typst-backend:
    name: "Typst Backend - ${{ matrix.platform }} - ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        platform:
          - typst     # Typst_jll
          - native    # System typst
          - none      # Source only
        os:
          - ubuntu-latest
          - windows-latest
        exclude:
          # Native typst not available on Windows in CI
          - os: windows-latest
            platform: native
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install system Typst (native platform)
        if: matrix.platform == 'native'
        run: |
          curl -fsSL https://github.com/typst/typst/releases/download/v0.12.0/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJ
          sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
          typst --version

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Install package
        run: |
          julia --project=test/typst_backend -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'

      - name: Run Typst backend tests
        run: julia --project=test/typst_backend --code-coverage test/typst_backend/runtests.jl
        env:
          TYPST_PLATFORM: ${{ matrix.platform }}

      - name: Process coverage
        uses: julia-actions/julia-processcoverage@v1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          flags: typst-backend

      - name: Submit coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: lcov.info
          flag-name: typst-${{ matrix.platform }}-${{ matrix.os }}
          parallel: true

      - name: Upload Typst artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: typst-${{ matrix.platform }}-${{ matrix.os }}
          path: |
            test/typst_backend/builds/**/*.typ
            test/typst_backend/builds/**/*.pdf
          retention-days: 7

  # ============================================================================
  # Documentation
  # ============================================================================

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pages: write
      id-token: write
      statuses: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Build and deploy documentation
        uses: julia-actions/julia-docdeploy@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
          GKSwstype: "100"
          JULIA_DEBUG: "Documenter"
          DATADEPS_ALWAYS_ACCEPT: true

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: documentation-html
          path: docs/build/
          retention-days: 7

  linkcheck:
    name: "Linkcheck: Documentation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'
      - uses: julia-actions/cache@v2
      - name: Install dependencies
        run: |
          julia --project=docs -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'
      - name: Build and check documentation
        run: julia --color=yes --project=docs/ docs/make.jl linkcheck
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Finalization
  # ============================================================================

  close-coveralls:
    name: "Close Coveralls Submission"
    needs: [test, typst-backend]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Coveralls Finished
        uses: coverallsapp/github-action@v2
        with:
          parallel-finished: true

  # ============================================================================
  # Release (on tags)
  # ============================================================================

  release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test, typst-backend, docs, linkcheck]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## DocumenterTypst ${{ steps.get_version.outputs.VERSION }}

          ### Installation

          \`\`\`julia
          using Pkg
          Pkg.add(name="DocumenterTypst", version="${{ steps.get_version.outputs.VERSION }}")
          \`\`\`

          ### Documentation

          - [Stable Documentation](https://lucifer1004.github.io/DocumenterTypst.jl/stable/)
          - [API Reference](https://lucifer1004.github.io/DocumenterTypst.jl/stable/api/reference/)

          ### Changes

          See [CHANGELOG.md](https://github.com/lucifer1004/DocumenterTypst.jl/blob/main/CHANGELOG.md) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'rc') || contains(steps.get_version.outputs.VERSION, 'beta') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
