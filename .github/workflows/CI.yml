# Comprehensive CI workflow for DocumenterTypst.jl
#
# Test Strategy (Optimized):
# 1. Unit Tests: Fast, run on full Julia Ã— OS matrix
# 2. Integration Tests: Medium, run on OS matrix
# 3. Snapshot Tests: run ONCE on ubuntu + julia 1
#

name: CI

on:
  push:
    branches:
      - main
      - "release-*"
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.ref != 'refs/heads/main' || github.run_number }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================

  changelog:
    name: Changelog Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - uses: dangoslen/changelog-enforcer@v3
        with:
          changeLogPath: "CHANGELOG.md"
          skipLabels: "Skip Changelog,dependencies"

  runic:
    name: "Runic (Julia code formatting)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: "1"
      - uses: julia-actions/cache@v2
      - uses: fredrikekre/runic-action@v1
        with:
          version: "1.5"

  markdownlint:
    name: "Markdownlint (Markdown linting)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: |
            **/*.md
            !**/node_modules
            !docs/build
            !docs/build-typst
            !test/**/build
            !test/**/builds
            !test/**/build-debug

  typos:
    name: Spell Check with Typos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: crate-ci/typos@master

  # ============================================================================
  # Unit Tests (Fast - Full Matrix)
  # ============================================================================

  unit-tests:
    name: Unit Tests - Julia ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        version:
          - "lts"
          - "1"
          - "nightly"
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        arch:
          - default
        include:
          - os: ubuntu-latest
            version: "1"
            arch: x86
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
          show-versioninfo: true

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Build package
        uses: julia-actions/julia-buildpkg@v1

      - name: Run unit tests
        run: julia --project=. --code-coverage test/run_unit_tests.jl

      - name: Process coverage
        uses: julia-actions/julia-processcoverage@v1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          flags: unit-tests

  # ============================================================================
  # Integration Tests (Medium - Platform Matrix)
  # ============================================================================

  integration-tests:
    name: "Integration - ${{ matrix.platform }} - ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        platform:
          - typst
          - native
          - none
        os:
          - ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install system Typst (native platform)
        if: matrix.platform == 'native'
        uses: typst-community/setup-typst@v4

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1"

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Install package
        run: |
          julia --project=test/integration -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'

      - name: Run integration tests
        run: julia --project=test/integration --code-coverage test/integration/runtests.jl
        env:
          TYPST_PLATFORM: ${{ matrix.platform }}

      - name: Process coverage
        uses: julia-actions/julia-processcoverage@v1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          flags: integration-tests

  # ============================================================================
  # Snapshot Tests (Slow - Single Job Only)
  # ============================================================================

  snapshot-tests:
    name: "Snapshot Tests (Text + Visual)"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1"

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Build package
        uses: julia-actions/julia-buildpkg@v1

      - name: Install integration test dependencies
        run: |
          julia --project=test/integration -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'

      - name: Run snapshot tests
        run: julia --project=. --code-coverage test/run_snapshot_tests.jl

      - name: Upload failed visual snapshots
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: visual-test-failures
          path: test/snapshots/visual/failures/
          retention-days: 7

      - name: Process coverage
        uses: julia-actions/julia-processcoverage@v1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: lcov.info
          flags: snapshot-tests

  # ============================================================================
  # Documentation
  # ============================================================================

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      statuses: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1"

      - name: Cache Julia packages
        uses: julia-actions/cache@v2

      - name: Build and deploy documentation
        uses: julia-actions/julia-docdeploy@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
          GKSwstype: "100"
          JULIA_DEBUG: "Documenter"
          DATADEPS_ALWAYS_ACCEPT: true

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: documentation-html
          path: docs/build/
          retention-days: 7

  linkcheck:
    name: "Linkcheck: Documentation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: "1"
      - uses: julia-actions/cache@v2
      - name: Install dependencies
        run: |
          julia --project=docs -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'
      - name: Build and check documentation
        run: julia --color=yes --project=docs/ docs/make.jl linkcheck
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Release (on tags)
  # ============================================================================

  release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [unit-tests, integration-tests, snapshot-tests, docs, linkcheck]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## DocumenterTypst ${{ steps.get_version.outputs.VERSION }}

          ### Installation

          ```julia
          using Pkg
          Pkg.add(name="DocumenterTypst", version="${{ steps.get_version.outputs.VERSION }}")
          ```

          ### Documentation

          - [Stable Documentation](https://lucifer1004.github.io/DocumenterTypst.jl/stable/)
          - [API Reference](https://lucifer1004.github.io/DocumenterTypst.jl/stable/api/reference/)

          ### Changes

          See [CHANGELOG.md](https://github.com/lucifer1004/DocumenterTypst.jl/blob/main/CHANGELOG.md) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'rc') || contains(steps.get_version.outputs.VERSION, 'beta') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
