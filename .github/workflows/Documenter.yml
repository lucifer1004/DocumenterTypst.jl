# Documentation deployment workflow
#
# Builds HTML documentation and deploys to GitHub Pages
# Supports versioning for releases

name: Documentation

on:
  push:
    branches:
      - main
    tags: ["*"]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Sets permissions for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write
  statuses: write
  pull-requests: write

# Allow one concurrent deployment
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1"

      - name: Cache Julia artifacts
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-docs
          cache-registries: "true"
          cache-artifacts: "true"

      - name: Install dependencies
        shell: julia --color=yes --project=docs {0}
        run: |
          using Pkg
          Pkg.develop(PackageSpec(path=pwd()))
          Pkg.instantiate()

      - name: Build HTML documentation
        shell: julia --color=yes --project=docs {0}
        run: |
          # Set environment for docs build
          ENV["DOCUMENTER_KEY"] = get(ENV, "DOCUMENTER_KEY", "")
          ENV["GITHUB_TOKEN"] = get(ENV, "GITHUB_TOKEN", "")
          ENV["JULIA_DEBUG"] = "Documenter"

          include("docs/make.jl")

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v6
        with:
          name: documenter-html
          path: docs/build/
          retention-days: 7

  # Separate job for PR preview comments
  preview-comment:
    name: Preview Documentation Comment
    needs: build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const comment_body = `
            ðŸ“š **Documentation Preview**

            The documentation for this PR has been built successfully!

            - **Workflow Run**: [View Details](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Commit**: ${context.sha.substring(0, 7)}

            _Note: Full preview deployment requires approval from maintainers._
            `;

            // Check if comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“š **Documentation Preview**')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment_body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: comment_body,
              });
            }
